<mvc:View
    controllerName="productlist.controller.Main"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:smartTable="sap.ui.comp.smarttable"
    xmlns:smartFilterBar="sap.ui.comp.smartfilterbar"
    xmlns:core="sap.ui.core"
    height="100%"
>
    <Page
        title="Product Inventory"
        enableScrolling="false"
        class="sapUiResponsiveContentPadding"
    >
        <content>
            <HBox justifyContent="End" alignItems="Center" class="sapUiSmallMarginBottom">
                <!-- Admin Add Product Button -->
                <Button
                    id="addProductButton"
                    text="Add Product"
                    icon="sap-icon://add"
                    type="Emphasized"
                    press="onAddProduct"
                    visible="{user>/isAdmin}"
                    class="sapUiTinyMarginEnd"
                />
                
                <Button
                    id="notificationButton"
                    icon="sap-icon://bell"
                    type="Emphasized"
                    press="onNotificationPress"
                    tooltip="Notifications"
                    text=""
                    class="sapUiTinyMarginEnd"
                />

            </HBox>
            <VBox
                height="100%"
                class="sapUiNoMargin"
            >
                <!-- Smart Table with full height -->
                <smartTable:SmartTable
                    id="smartTable"
                    tableType="ResponsiveTable"
                    useExportToExcel="true"
                    useVariantManagement="false"
                    useTablePersonalisation="true"
                    header=""
                    showRowCount="false"
                    enableAutoBinding="false"
                    class="sapUiNoMargin sapUiNoContentPadding"
                    height="100%"
                    width="100%"
                >
                    <!-- Custom Toolbar -->
                    <smartTable:customToolbar>
                        <Toolbar height="3rem">
                            <Title
                                id="tableTitle"
                                text="Products"
                                level="H2"
                                class="sapUiMediumMarginBegin"
                            />
                            <ToolbarSpacer />
                            <!-- Role and user indicator -->
                            <Label
                                text="User: {user>/userName} ({user>/role})"
                                class="sapUiTinyMarginEnd"
                                design="Bold"
                            />
                        </Toolbar>
                    </smartTable:customToolbar>

                    <!-- Table Definition -->
                    <Table
                        id="productTable"
                        items="{/Product}"
                        growing="true"
                        growingScrollToLoad="false"
                        growingThreshold="50"
                        width="100%"
                        fixedLayout="false"
                        backgroundDesign="Solid"
                    >
                        <columns>
                            <Column
                                width="12rem"
                                minScreenWidth="Tablet"
                                demandPopin="true"
                                popinDisplay="Inline"
                                hAlign="Begin"
                            >
                                <Text text="Name" />
                            </Column>

                            <Column
                                width="15rem"
                                minScreenWidth="Desktop"
                                demandPopin="true"
                                popinDisplay="Block"
                                hAlign="Begin"
                            >
                                <Text text="Description" />
                            </Column>

                            <Column
                                width="10rem"
                                minScreenWidth="Tablet"
                                demandPopin="true"
                                popinDisplay="Inline"
                                hAlign="Center"
                            >
                                <Text text="Category" />
                            </Column>

                            <Column
                                width="8rem"
                                minScreenWidth="Tablet"
                                demandPopin="false"
                                hAlign="End"
                            >
                                <Text text="Unit Price" />
                            </Column>

                            <Column
                                width="8rem"
                                minScreenWidth="Phone"
                                demandPopin="false"
                                hAlign="Center"
                            >
                                <Text text="Quantity" />
                            </Column>

                            <Column
                                width="10rem"
                                minScreenWidth="Desktop"
                                demandPopin="true"
                                popinDisplay="Inline"
                                hAlign="Center"
                            >
                                <Text text="Min Stock" />
                            </Column>

                            <Column
                                width="10rem"
                                minScreenWidth="Desktop"
                                demandPopin="true"
                                popinDisplay="Block"
                                hAlign="Center"
                            >
                                <Text text="Last Updated" />
                            </Column>

                            <!-- Actions Column - Only visible for admins -->
                            <Column
                                width="8rem"
                                minScreenWidth="Desktop"
                                demandPopin="false"
                                hAlign="Center"
                                visible="{user>/isAdmin}"
                            >
                                <Text text="Actions" />
                            </Column>
                        </columns>

                        <items>
                            <ColumnListItem
                                press="onItemPress"
                                type="Active"
                            >
                                <cells>
                                    <VBox>
                                        <Text
                                            text="{Name}"
                                            maxLines="2"
                                            class="sapUiTinyMarginBottom"
                                        />
                                        <Label
                                            text="ID: {ID}"
                                            class="sapUiTinyText"
                                        />
                                    </VBox>

                                    <Text
                                        text="{Description}"
                                        maxLines="3"
                                    />

                                    <ObjectStatus
                                        text="{Category}"
                                        state="Information"
                                    />

                                    <ObjectNumber
                                        number="{UnitPrice}"
                                        unit="RWF"
                                        state="Success"
                                    />

                                    <VBox>
                                        <ObjectNumber
                                            number="{Quantity}"
                                            state="{
                                                parts: ['Quantity', 'MinimumStockLevel'],
                                                formatter: '.formatStockState'
                                            }"
                                        />
                                        <ProgressIndicator
                                            percentValue="{
                                                parts: ['Quantity', 'MinimumStockLevel'],
                                                formatter: '.calculateStockPercentage'
                                            }"
                                            state="{
                                                parts: ['Quantity', 'MinimumStockLevel'],
                                                formatter: '.formatStockState'
                                            }"
                                            showValue="false"
                                            width="100%"
                                            height="0.25rem"
                                            class="sapUiTinyMarginTop"
                                        />
                                    </VBox>

                                    <ObjectNumber
                                        number="{MinimumStockLevel}"
                                        state="None"
                                    />

                                    <VBox>
                                        <Text text="{LastUpdated}" />
                                        <Label
                                            text="{
                                            path: 'LastUpdated',
                                            formatter: '.formatTimeAgo'
                                        }"
                                            class="sapUiTinyText"
                                        />
                                    </VBox>

                                    <!-- Action Buttons - Only visible for admins -->
                                    <VBox>
                                        <HBox visible="{= ${user>/isAdmin} ? true : false}">
                                            <Button
                                                icon="sap-icon://edit"
                                                type="Transparent"
                                                press="onEditProduct"
                                                tooltip="Edit Product"
                                                class="sapUiTinyMarginEnd"
                                                visible="{user>/isAdmin}"
                                            />
                                            <Button
                                                icon="sap-icon://delete"
                                                type="Transparent"
                                                press="onDeleteProduct"
                                                tooltip="Delete Product"
                                                visible="{user>/isAdmin}"
                                            />
                                        </HBox>
                                    </VBox>
                                </cells>
                            </ColumnListItem>
                        </items>
                    </Table>
                </smartTable:SmartTable>
            </VBox>
        </content>
    </Page>

    <!-- Notification Popover -->
    <Popover
        id="notificationPopover"
        title="Notifications"
        placement="Bottom"
        contentWidth="25rem"
        contentHeight="20rem"
    >
        <content>
            <VBox class="sapUiMediumMargin">
                <List
                    items="{notifications>/notifications}"
                    noDataText="No notifications available"
                >
                    <StandardListItem
                        title="{notifications>title}"
                        description="{notifications>description}"
                        info="{path:'notifications>createdAt', formatter:'.formatTimeAgo'}"
                        type="Active"
                        icon="{path: 'notifications>priority', formatter: '.formatPriorityIcon'}"
                        iconDensityAware="false"
                        iconInset="false"
                        infoState="{path: 'notifications>priority', formatter: '.formatPriorityState'}"
                        class="{path: 'notifications>priority', formatter: '.formatPriorityClass'}"
                        press="onNotificationItemPress"
                    />
                </List>
                <Toolbar>
                    <ToolbarSpacer />
                    <Button
                        text="Mark All Read"
                        press="onMarkAllRead"
                        type="Emphasized"
                    />
                    <Button
                        text="Clear All"
                        press="onClearAllNotifications"
                        type="Ghost"
                    />
                </Toolbar>
            </VBox>
        </content>
    </Popover>
</mvc:View>